# Shared Infrastructure for Logic Apps Samples

Reusable Bicep modules, templates, and scripts that provide consistent infrastructure across all Logic Apps samples.

## Quick Start

```powershell
# 1. Create folder structure
samples/your-sample-name/
├── Deployment/          # Generated assets (empty initially)
└── LogicApps/          # Your workflows go here

# 2. Generate deployment files
.\samples\shared\scripts\BundleAssets.ps1 -Sample "your-sample-name"

# 3. Deploy infrastructure
az group create --name rg-test --location westeurope
az deployment group create `
  --resource-group rg-test `
  --template-file samples/your-sample-name/Deployment/main.bicep `
  --parameters BaseName=test123

# 4. Upload local workflows (deployment-script 404 is expected!)
az webapp deploy `
  --name test123-logicapp `
  --resource-group rg-test `
  --src-path samples/your-sample-name/Deployment/workflows.zip `
  --type zip

# 5. Test your workflows in Azure Portal
```

## Directory Structure

```
shared/
├── modules/                    # 6 reusable Bicep modules
│   ├── storage.bicep
│   ├── openai.bicep
│   ├── logicapp.bicep
│   ├── storage-rbac.bicep
│   ├── openai-rbac.bicep
│   └── deployment-script.bicep
├── scripts/
│   └── BundleAssets.ps1       # Generates deployment artifacts
└── templates/
    └── main.bicep.template    # Infrastructure template
```

## Bicep Modules

Six reusable modules provide complete Logic Apps infrastructure:

| Module | Purpose |
|--------|---------|
| **storage.bicep** | Storage Account for Logic App runtime (managed identity only, HTTPS/TLS 1.2, no shared keys) |
| **openai.bicep** | Azure OpenAI S0 with gpt-4o-mini model (GlobalStandard, 150K tokens) |
| **logicapp.bicep** | Logic App Standard with App Service Plan (WS1 SKU, system + user-assigned identities) |
| **storage-rbac.bicep** | Storage Blob/Queue/Table Data Contributor roles for Logic App |
| **openai-rbac.bicep** | Cognitive Services OpenAI User role for Logic App |
| **deployment-script.bicep** | Downloads and deploys workflows.zip using deployment script |

## BundleAssets.ps1 Script

Generates all deployment artifacts for a sample:

```powershell
# Basic usage
.\samples\shared\scripts\BundleAssets.ps1 -Sample "your-sample-name"

# Force regeneration of main.bicep (overwrites existing file)
.\samples\shared\scripts\BundleAssets.ps1 -Sample "your-sample-name" -Force
```

**Generates:**
1. `main.bicep` - From template (only if doesn't exist, preserves customizations)
2. `sample-arm.json` - Compiled ARM template
3. `workflows.zip` - Bundled LogicApps folder

**Parameters:**
- `-Sample` (required) - Name of the sample folder
- `-Force` (optional) - Regenerates main.bicep even if it exists (useful for updating URLs)

**How it works:**
- Uses hardcoded `Azure/logicapps-labs` main branch for upstream URLs
- Preserves existing `main.bicep` unless `-Force` is specified
- Replaces `{{WORKFLOWS_ZIP_URL}}` template placeholder with upstream URL
- Requires Bicep CLI and PowerShell 5.1+

**Why upstream URLs?** The generated `workflowsZipUrl` parameter points to the upstream main branch so the "Deploy to Azure" button works for end users. The deployment-script module downloads and deploys workflows.zip from this URL automatically. For local testing before merge, use `az webapp deploy` to upload your local zip file instead.

## Creating a New Sample

### 1. Create Folder Structure

```
samples/your-sample-name/
├── Deployment/          # Empty (generated by script)
└── LogicApps/          # Your workflows
    ├── host.json
    ├── connections.json
    └── YourWorkflow/
        └── workflow.json
```

### 2. Generate Deployment Files

```powershell
.\samples\shared\scripts\BundleAssets.ps1 -Sample "your-sample-name"
```

Creates `Deployment/main.bicep` with:
- 6 shared module references
- `workflowsZipUrl` parameter pointing to upstream main (for "Deploy to Azure" button)
- Standard BaseName and location parameters

The upstream URL enables the deployment-script module to automatically download and deploy workflows.zip when users click "Deploy to Azure".

### 3. Customize (Optional)

Edit `Deployment/main.bicep` to add sample-specific resources or configurations. The script won't overwrite your changes.

### 4. Test Locally

```powershell
# Create resource group (use supported region)
az group create --name rg-test --location westeurope

# Deploy infrastructure
az deployment group create `
  --resource-group rg-test `
  --template-file samples/your-sample-name/Deployment/main.bicep `
  --parameters BaseName=test123

# Upload local workflows (deployment-script 404 is normal!)
az webapp deploy `
  --name test123-logicapp `
  --resource-group rg-test `
  --src-path samples/your-sample-name/Deployment/workflows.zip `
  --type zip

# Test workflows in Azure Portal
```

### 5. Commit After Testing

```powershell
git add samples/your-sample-name/
git commit -m "Add your-sample-name sample"
git push
```

## Local Testing Details

### Prerequisites

- Azure CLI and Bicep CLI installed
- Azure subscription with:
  - Azure OpenAI access ([request here](https://aka.ms/oai/access))
  - Logic Apps Standard quota
- Supported regions: **eastus2**, **westeurope**, **australiaeast**

### Expected Deployment Behavior

**Infrastructure deployment:**
- ✅ Storage Account deploys successfully
- ✅ Azure OpenAI deploys successfully
- ✅ Logic App deploys successfully
- ✅ RBAC roles assigned successfully
- ❌ **deployment-script fails with 404** - This is **expected**! workflows.zip isn't on main yet.

**Solution:** Use `az webapp deploy` to upload your local workflows.zip directly.

### Validation Checklist

After deployment:
- ✅ All resources visible in Azure Portal
- ✅ Logic App has system + user-assigned managed identities
- ✅ Storage uses managed identity only (no keys)
- ✅ Workflows deployed and visible in Logic App
- ✅ Workflows execute successfully
- ✅ OpenAI connections work

### Troubleshooting

| Issue | Solution |
|-------|----------|
| **Deployment-script 404** | Normal for local testing - use `az webapp deploy` instead |
| **Logic Apps quota error** | Try different region: eastus2, westeurope, or australiaeast |
| **OpenAI access denied** | Request access at https://aka.ms/oai/access |
| **Region not supported** | Use eastus2, westeurope, or australiaeast only |

### Cleanup

```powershell
az group delete --name rg-test --yes --no-wait
```

## Benefits

✅ **Consistency** - All samples use identical infrastructure patterns  
✅ **Security** - Managed identity only, RBAC-based, no shared keys  
✅ **Simplicity** - One script, three files, ready to deploy  
✅ **Testable** - Local testing workflow with `az webapp deploy`  
✅ **Maintainable** - Fix modules once, all samples benefit  

## Examples

See existing samples:
- [product-return-agent-sample](../product-return-agent-sample/)
- [ai-loan-agent-sample](../ai-loan-agent-sample/)
